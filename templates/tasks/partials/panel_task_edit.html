{% load djicons i18n %}

<div x-data="{ confirmDelete: false, taskType: '{{ task.task_type }}' }">

    <!-- Header -->
    <div class="side-sheet-header">
        <h3 class="sheet-title">{% trans "Edit Task" %}</h3>
        <button class="sheet-close" @click="closePanel()">
            {% icon "close-outline" %}
        </button>
    </div>

    <!-- Body -->
    <div class="side-sheet-content">
        <form id="edit-task-form"
              hx-post="{% url 'tasks:edit' task_id=task.id %}"
              hx-target="#datatable-body"
              hx-swap="innerHTML"
              @htmx:after-request="closePanel()"
              class="flex flex-col gap-4 p-6">
            {% csrf_token %}

            <!-- Title -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Title" %} *</label>
                <input type="text" name="title" class="input input-sm w-full"
                       value="{{ task.title }}" placeholder="{% trans 'Task title' %}" required>
            </div>

            <!-- Type, Priority & Status -->
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="text-sm font-medium mb-1 block">{% trans "Type" %}</label>
                    <select name="task_type" class="select select-sm w-full" x-model="taskType">
                        {% for value, label in type_choices %}
                        <option value="{{ value }}" {% if task.task_type == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium mb-1 block">{% trans "Priority" %}</label>
                    <select name="priority" class="select select-sm w-full">
                        {% for value, label in priority_choices %}
                        <option value="{{ value }}" {% if task.priority == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium mb-1 block">{% trans "Status" %}</label>
                    <select name="status" class="select select-sm w-full">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if task.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Due Date -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Due Date" %}</label>
                <input type="datetime-local" name="due_date" class="input input-sm w-full"
                       value="{{ due_date_value }}">
            </div>

            <!-- Customer -->
            {% if customers %}
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Customer" %}</label>
                <select name="customer" class="select select-sm w-full">
                    <option value="">{% trans "No customer" %}</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if task.customer_id == customer.id %}selected{% endif %}>{{ customer.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Description -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Description" %}</label>
                <textarea name="description" class="textarea textarea-sm w-full" rows="2"
                          placeholder="{% trans 'Description (optional)' %}">{{ task.description }}</textarea>
            </div>

            <!-- Duration (for calls/meetings) -->
            <div x-show="taskType === 'call' || taskType === 'meeting'" x-cloak>
                <label class="text-sm font-medium mb-1 block">{% trans "Duration (minutes)" %}</label>
                <input type="number" name="duration_minutes" class="input input-sm w-full"
                       min="0" value="{{ task.duration_minutes|default:'' }}" placeholder="30">
            </div>

            <!-- Location (for meetings) -->
            <div x-show="taskType === 'meeting'" x-cloak>
                <label class="text-sm font-medium mb-1 block">{% trans "Location" %}</label>
                <input type="text" name="location" class="input input-sm w-full"
                       value="{{ task.location }}" placeholder="{% trans 'Meeting location' %}">
            </div>

            <!-- Result (for calls/meetings) -->
            <div x-show="taskType === 'call' || taskType === 'meeting'" x-cloak>
                <label class="text-sm font-medium mb-1 block">{% trans "Result / Outcome" %}</label>
                <textarea name="result" class="textarea textarea-sm w-full" rows="2"
                          placeholder="{% trans 'Call/meeting outcome' %}">{{ task.result }}</textarea>
            </div>

            <!-- Reminder -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Reminder (minutes before)" %}</label>
                <input type="number" name="reminder_before_minutes" class="input input-sm w-full"
                       min="0" value="{{ task.reminder_before_minutes }}" placeholder="30">
            </div>
        </form>

        <!-- Completion info -->
        {% if task.completed_at %}
        <div class="border-t border-base-300 pt-4 mt-4 px-6">
            <div class="flex items-center gap-2 text-sm text-success">
                {% icon "checkmark-circle-outline" %}
                <span>{% trans "Completed" %} {{ task.completed_at|date:"M d, Y H:i" }}</span>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="border-t border-base-300 pt-4 mt-4 px-6">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-semibold text-sm">{% trans "Quick Actions" %}</h4>
                </div>
                <div class="flex gap-2">
                    {% if not task.is_completed %}
                    <button class="btn btn-sm color-success"
                            hx-post="{% url 'tasks:complete' task_id=task.id %}"
                            hx-target="#datatable-body"
                            hx-swap="innerHTML"
                            @click="closePanel()">
                        {% icon "checkmark-circle-outline" %}
                        {% trans "Complete" %}
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-outline"
                            hx-post="{% url 'tasks:reopen' task_id=task.id %}"
                            hx-target="#datatable-body"
                            hx-swap="innerHTML"
                            @click="closePanel()">
                        {% icon "refresh-outline" %}
                        {% trans "Reopen" %}
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Delete Section -->
        <div class="border-t border-base-300 pt-4 mt-4 px-6 pb-6">
            <h4 class="font-semibold text-sm mb-3 text-error">{% trans "Danger Zone" %}</h4>

            <template x-if="!confirmDelete">
                <button type="button" class="btn btn-sm btn-outline color-error w-full"
                        @click="confirmDelete = true">
                    {% icon "trash-outline" %}
                    {% trans "Delete Task" %}
                </button>
            </template>

            <template x-if="confirmDelete">
                <div>
                    <p class="text-error text-sm font-semibold mb-3">
                        {% trans "Are you sure?" %}
                    </p>
                    <div class="flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline flex-1"
                                @click="confirmDelete = false">
                            {% trans "Cancel" %}
                        </button>
                        <button type="button" class="btn btn-sm color-error flex-1"
                                hx-post="{% url 'tasks:delete' task.id %}"
                                hx-target="#datatable-body"
                                hx-swap="innerHTML"
                                @click="closePanel()">
                            {% icon "trash-outline" %}
                            {% trans "Delete" %}
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Footer -->
    <div class="side-sheet-footer">
        <div class="flex justify-end gap-2">
            <button type="button" class="btn btn-ghost btn-sm" @click="closePanel()">
                {% trans "Cancel" %}
            </button>
            <button type="submit" form="edit-task-form" class="btn btn-sm color-primary">
                {% icon "checkmark-outline" %}
                {% trans "Save" %}
            </button>
        </div>
    </div>

</div>
